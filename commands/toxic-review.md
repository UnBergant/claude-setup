---
name: toxic-review
description: Двойное код-ревью — Codex CLI + Claude параллельно анализируют изменения и объединяют находки
argument-hint: "[ветка|sha|пусто для незакоммиченных]"
allowed-tools: Bash, Read
---

# Навык: Двойное код-ревью через Codex CLI

Пользователь хочет получить ревью кода от двух AI — Codex и Claude — с объединением находок.

**Аргумент пользователя:** $ARGUMENTS

---

## Твоя роль

Ты проводишь code review параллельно с Codex. Два ревьюера лучше одного — вы можете найти разные проблемы. Твоя задача:
- Определить scope ревью (uncommitted / vs branch / конкретный коммит)
- Запустить `codex exec review` с правильными флагами
- Провести собственное ревью того же diff
- Объединить находки, выделив что нашли оба (высокая уверенность) и что нашёл только один

## Определение scope

Интерпретация `$ARGUMENTS`:

| Аргумент | Что ревьюим | Флаги Codex | Git diff |
|----------|-------------|-------------|----------|
| *(пусто)* | Незакоммиченные изменения | `--uncommitted` | `git diff && git diff --cached` |
| Имя ветки | Изменения vs ветка | `--base {branch}` | `git diff {branch}...HEAD` |
| SHA коммита | Конкретный коммит | `--commit {sha}` | `git show {sha}` |

Проверь валидность: `git rev-parse --verify {ref}`. Если невалидно или diff пустой — сообщи пользователю.

## Запуск Codex review

```bash
codex exec review {flags} \
  --ephemeral \
  -o /tmp/codex-review-{ts}.txt \
  2>&1
```

Таймаут: 180 секунд. При таймауте — проведи своё ревью самостоятельно.

## Своё ревью

Получи diff через git и проанализируй. Фокус:
- **Корректность** — логические ошибки, edge cases, баги
- **Безопасность** — инъекции, секреты в коде, unsafe операции
- **Производительность** — N+1, лишние вычисления, утечки памяти
- **Типы** — TypeScript type safety, any-касты
- **Архитектура** — соответствие дизайну проекта (CLAUDE.md / TECH.md)

Для больших diff (>500 строк) сосредоточься на новых файлах, конфигах и критичных изменениях.

## Формат вывода

```
## Dual Code Review

**Область:** {что ревьюили}
**Файлов затронуто:** {N}

### Ревью Codex
{ответ Codex, отформатированный}

### Моё ревью

#### Критичное
{баги, безопасность — обязательно исправить}

#### Важное
{дизайн, производительность, типы — стоит исправить}

#### Мелочи
{стиль, именование — опционально}

### Объединённые находки
- **Оба нашли:** {проблемы от обоих — высокая уверенность}
- **Только Codex:** {оценить валидность}
- **Только я:** {оценить валидность}
- **Рекомендация:** APPROVE / REQUEST CHANGES / обсудить
```

## Обработка ошибок

- **Codex не установлен** → `npm install -g @openai/codex`
- **Нет аутентификации** → `codex login`
- **Нет изменений** → сообщить и остановиться
- **Невалидная ветка/SHA** → сообщить и остановиться
- **Таймаут / пустой ответ** → показать только своё ревью, отметить что Codex не ответил